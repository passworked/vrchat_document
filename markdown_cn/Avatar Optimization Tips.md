# 模型优化技巧
##### 注意
本指南并不包含所有的头像优化方式！正确优化您的头像需要对大量事物有相当广泛的了解。我们并不指望每个人都了解一切。

但是，我们会尽最大努力使本文档保持更新，其中包含人们最常错过的事情，以及要达到的最重要的目标。

如果您对优化提示有意见，请使用右上角的 Suggest Edits 按钮并添加您自己的建议！

您是否希望您的头像高效并因为您为它们提高帧率而受到所有人的喜爱？遵循这些提示就能成功！

本文档中建议的任何数字或限制都可能随时更改。尽管下面提供的一些描述在技术上并不精确，但本文档旨在帮助新手用户学习如何优化他们的头像。

社区创建的 blender 插件（如 [Cats](https://catsblenderplugin.xyz/) 或 [Tuxedo](https://github.com/feilen/tuxedo-blender-plugin)）允许用户非常轻松地优化他们的模型并协助解决常见的 VRChat 头像问题。我们强烈建议使用这样的工具！它使您的工作更轻松，并提高了所有人的性能。

顺便说一句，SDK 的 Build Control 面板提供了许多关于头像的组件，以帮助进行优化。

## 针对 Android/Quest 优化您的内容
在 Android 开发内容时，请牢记[内容限制](https://creators.vrchat.com/platforms/android/quest-content-limitations)!例如，头像无权访问所有着色器和头像组件。
此外，您应该[针对 Android 优化您的内容](https://creators.vrchat.com/platforms/android/quest-content-optimization) 。这会提高您的头像的[性能等级](https://creators.vrchat.com/avatars/avatar-performance-ranking-system) ，并允许更多玩家看到您的头像。

## 不要使用 Dynamic Bones！
Dynamic Bones 允许您定义头像绑定上的骨骼，使其像悬挂一样四处移动。您还可以定义重力等静态力，这些力可以使头发更真实地落下。
Dynamic Bones 已弃用，最终将被删除。请改用 PhysBones。
VRChat 将在运行时自动将 Dynamic Bones 转换为 PhysBones。

## 请勿使用 Unity 约束！
Unity 约束是引擎提供的组件，允许您根据一个或多个其他转换来更改头像上变换的位置、旋转和缩放。

引擎的约束根据每帧之间的依赖关系进行排序，这意味着当它们同时存在足够多的约束时，它们可能会导致严重的性能问题。请改用 VRChat 约束 ，因为它们旨在在 VRChat 头像的上下文中提供更好的性能。

VRChat 会在运行时自动将 Unity 约束转换为 VRChat 约束。

Cloth 是 Unity 的默认组件，其性能开销与 Dynamic Bones 相似，但设置起来更复杂。应尽量减少使用 Cloth，且不要将其应用于顶点数超过约 200 个的网格上。

## 减少头像上的网格数量
您的头像上可以有两种类型的网格渲染器 - 静态网格渲染器和蒙皮网格渲染器。静态网格不会变形。但是，蒙皮网格通常具有绑定（骨骼），用于告诉引擎如何根据骨骼的位置移动和变形网格。这些蒙皮网格的成本要高得多，并且您的头像上应该只有一个蒙皮网格渲染器。几乎没有理由拥有多个 - 大多数情况下，其他物品可以内置到原始模型中。

最重要的是，您的头像上每个额外的网格都会产生一个或多个额外的“绘制调用”，本质上是处理器告诉您的显卡在屏幕上绘制内容所花费的时间。

因此，VRChat 建议您最多使用 1 个蒙皮网格渲染器，最多使用 3 个静态网格渲染器。 在 Blender 中将网格合并在一起非常简单，如下面的 网格 视频所示。

最后，确保您没有使用过多的三角形。如果您尝试上传的模型超过 70,000 个三角形（对于 PC）或 20,000 个三角形（在 Quest 上），SDK 将发出警告。您很少需要这么多多边形来获取细节 - 考虑烘焙法线贴图并通过抽取或重新拓扑来简化网格。

由于限制降低，为 Quest 创建头像可能更具挑战性。最有效的优化往往发生在初始设计和头像创建期间。换句话说，如果你试图将一个 120,000 个用于渲染的模型压缩成 20,000 个多边形，你会遇到问题。不要让事情变得比他们必须的更难 - 找到一个从低处开始的模型！20k 是一个相当大的回旋余地。

值得注意的是，如果您使用的是 Cats Blender 插件，它会在您“修复模型”时自动合并网格。 如果您使用 Cats 按材质或松散部件来分隔网格，以协助进行抽取或编辑，请不要忘记再次合并网格。
[网格优化](https://youtu.be/1fco-G2j0Jg)
## 减少您使用的材质槽的数量
每增加一个材质槽，就会增加一次绘制调用（draw call），这会占用更多的处理器时间！如果你使用了很多材质（超过 10 个），可以考虑使用纹理图集（Texture Atlasing）。借助社区创建的工具，制作图集变得非常简单。想了解更多细节，可以查看 Materials 视频。

顺便说一句，重要的是 Avatar 中 Renderer 组件上的材质槽数量。如果你在 20 个插槽中有相同的材质，那么从技术上讲，你仍然有 20 个“材质”。

这是由于 Unity 将网格拆分为子网格的方式造成的。对性能真正重要的是创建的子网格数量，Unity 根据材质槽创建子网格。
[材质优化](https://youtu.be/5LwRi26RxSQ)
##  注意您的 VRAM 使用情况！
即使您使用纹理图集，最终也可能使用比以前更多的 VRAM！

纹理会占用 VRAM。每个纹理的分辨率越高，它消耗的 VRAM 就越多。避免使用多个高分辨率纹理，或通过减少[Unity导入设置](https://docs.unity3d.com/Manual/class-TextureImporter.html)中的“Max Size”参数来减小其大小。

例如：如果 30 MB 的头像使用效率低下的高分辨率纹理，则可以使用 3 GB 的 VRAM。不要被头像的下载大小所迷惑。

查看[Poiyomi的纹理优化指南](https://www.poiyomi.com/blog/2022-10-17-texture-optimization) 。这是有关如何优化头像纹理的出色而全面的指南。

## 使用优化的着色器

某些着色器可能会导致在 GPU 上渲染所花费的时间过多。尽量使用 Unity Standard 着色器，或者您知道性能良好的着色器。如果您不知道如何判断着色器是否经过良好优化，那也没关系！以下是一些示例，这些当然不是所有可用的着色器，但都制作精良，具有各种功能。

- VRChat 的 SDK 包括针对移动设备优化的各种着色器，例如“Standard Lite”。
- [Xiexe 的“XSToon”Unity 着色器 （MIT）](https://github.com/Xiexe/Xiexes-Unity-Shaders) - 适用于 Unity 的 PBR“Toon”着色器集合。
- [Silent 的着色器](https://gitlab.com/s-ilent/SCSS)（MIT） - 用于卡通渲染的 Unity 着色器，最初基于已停产的 CubedParadox 的 Flat Lit Toon，具有许多方便的功能。
- [Poiyomi's Toon Shader](https://github.com/poiyomi/PoiyomiToonShader/releases) (MIT) - 一个非常强大、功能强大的着色器，有很多选项。
### 最小化多余的着色器通道
更技术性地说，应避免使用包含过多着色器通道（shader passes）的着色器，因为这会带来额外的绘制调用（draw calls）。这可能对大多数用户来说有些复杂，因此只要使用常见且经过社区验证的着色器，通常就足够了。
### 避免曲面细分
应始终避免在使用 Tessellation 的头像上使用着色器。 这在 “fur” 着色器中非常常见。 曲面细分是一种图形卡可以获取网格并将其细分以获得各种效果的方法。但是，这种效果非常昂贵 ，即使是最强大的显卡也会减慢速度。 不要使用具有镶嵌效果的着色器。 如果需要毛发效果，请考虑使用无需镶嵌即可重现效果的着色器，例如 [XSFur](https://xiexe.booth.pm/items/1084711) 和 [Warren 的 Fast Fur Shader。](https://warrenwolfy.gumroad.com/l/atntv)。
### 关键字
您还应该避免使用过多着色器关键字的着色器。这可能会导致在 VRChat 中渲染视图时出现严重且不可预测的问题，并且会用大量冗余错误消息填充您的输出日志。无需在着色器中包含过多的着色器关键字，因此请仅使用目标功能所需的关键字。
#### 清除关键字
更改或升级着色器时，请确保从材质中删除旧的、未使用的关键字。使用过多的关键词对性能和优化非常不利。它不仅会导致您自己的头像出现问题，还可能会阻止其他人正确看到所有着色器 。

VRChat SDK 包含一个工具，用于从头像上的材质中删除关键字。这个工具也能删除你需要的关键词，所以要小心使用。

通常，最好使用此工具检查关键字 - 如果您的关键字太多，则可能需要找到另一个着色器。Swap to Standard（切换到 Standard），清除关键字，然后切换到新着色器。
#### 着色器作者注意事项

您可能需要考虑使用 Standard 着色器保留的关键字作为您自己的关键字。这些基本上可以保证已经被保留，因此如果您必须使用关键字，请使用 Standard 和 Post Processing v2 已经定义的关键字。以下是[推荐使用的关键字列表](https://pastebin.com/83fQvZ3n) 。
### 透明度
Alpha 透明度也是着色器的另一个昂贵部分 - 通常您希望在着色器上使用 Cutout 或 Opaque 模式。透明度可能非常昂贵，因此只有在您知道自己在做什么的情况下才使用它！
### 测量绘制调用
Unity Profiler 在评估绘制调用（draw calls）数量时非常有用 —— 只需确保你关闭了方向光（Directional Light）的阴影，以便在相同条件下进行对比分析。
## 减少骨骼数量
即使您的围巾、裙子或头发中有一堆骨头，您没有用于任何用途，它们在蒙皮调用期间也可能会产生额外的成本，您的 GPU 必须担心这些成本。如果您不打算使用骨骼，请考虑删除骨骼并将其合并到父骨骼中。如果您想知道如何将骨骼的权重合并到其父骨骼中，请观看上面关于 Dynamic Bones 的视频，其中包括有关骨骼合并的部分。
## 减少发射量/粒子系统的数量
尽管粒子系统可以产生很多很酷的效果，但过多的粒子系统可能会给某些 PC 带来问题。限制您正在使用的粒子系统的数量，并限制在任何给定时刻发射的最大粒子数量。

有一些方法可以使粒子系统具有大量粒子并保持性能。如果您对此感兴趣，请查看 Sprite 粒子的动态批处理，不要使用碰撞，并确保粒子的移动简单。

如果您更倾向于技术，可以尝试查看 Unity 的 Profiler 视图来判断您的粒子模拟占用了多少 CPU 时间。一般来说，大的透明颗粒比许多较小的不透明颗粒更糟糕。Unity 的 Particle System 实际上非常优化， 如果使用得当，运行速度会很快。

## 限制您的头像使用的光源数量
头像上的光源是实时的，因此非常昂贵。向模型添加光源意味着光束接触的所有内容都将使用双倍的绘制调用进行渲染。额外的光源会使效果成倍增加。这显然对性能非常不利。 不要使用始终开启的光源。尝试使用 Animation Override 来打开和关闭手电筒，或者根本不使用光源。

如果使用光源，请关闭光源的 Shadows （阴影）。实时光源上的阴影非常昂贵，而且在移动的物体上通常看起来不是那么好。

粒子系统可以配置为为许多粒子启用光源。 永远不要这样做！ 每个带有光源的粒子都算作一个实时光源，这（再次）非常昂贵。

总的来说，VRChat 建议您完全不要在头像上使用任何类型的光源。 它们不仅会对您自己的头像的性能产生不利影响，还会使光源照射到的头像的性能成本成倍增加。
## 推荐的软件/插件
有大量软件可帮助您优化头像并更轻松地构建头像。

例如，查看[Pumkin's Avatar Tools](https://github.com/rurre/PumkinsAvatarTools)。此外，此 Editor 脚本还允许您快速查看头像的统计数据。此工具处于测试阶段，可能存在错误 - 请在 Pumkin 的 GitHub 上报告任何问题。

以下软件并非由 VRChat 创作。请阅读并遵守每个产品随附的许可。
- Unity
- Blender
- Cats Blender Plugin
- Shotariya's Material Combiner
- Pumkin's Avatar Tools  Pumkin
